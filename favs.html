<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- *** CHANGED: Updated title *** -->
  <title>My Favorites</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    /* Using existing 'vn-' class names for simplicity, but they now represent generic items */
    .vn-container { /* Renamed logically to item-container */
      border: 1px solid #ddd;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 5px;
    }
    .vn-title { /* Renamed logically to item-title */
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .vn-title a {
      text-decoration: none;
      color: #007bff;
    }
    .vn-title a:hover {
      text-decoration: underline;
    }
    .vn-description { /* Renamed logically to item-description (though not used in list anymore) */
      font-size: 16px;
      color: #555;
      margin-bottom: 10px;
    }
    .vn-image { /* Renamed logically to item-image */
      max-width: 100%;
      height: auto;
      margin-bottom: 10px;
      display: block; /* Ensure image takes block space */
    }
    .pagination {
      margin-top: 20px;
      text-align: center;
    }
    .pagination a {
      margin: 0 5px;
      text-decoration: none;
      color: #007bff;
    }
    .pagination a.active {
      font-weight: bold;
      color: #000;
    }
     /* --- REMOVED Styles for unused elements ---
    .vn-developers, .vn-tags, .vn-screenshots {
      margin-bottom: 10px;
    }
    .vn-developers ul, .vn-tags ul, .vn-screenshots ul {
      list-style-type: none;
      padding: 0;
    }
    .vn-developers li, .vn-tags li {
      display: inline-block;
      margin-right: 10px;
      background-color: #f0f0f0;
      padding: 5px 10px;
      border-radius: 3px;
    }
    .vn-screenshots img {
      max-width: 100px;
      margin-right: 10px;
    } */
    #details-container {
      display: none; /* Hide details by default */
    }
    #back-to-index {
      display: block;
      margin-top: 20px;
      text-decoration: none;
      color: #007bff;
    }
    /* --- REMOVED Style for vn-post-image as developers/posts list is gone ---
    .vn-post-image {
      max-width: 50px;
      height: auto;
      margin-left: 10px;
    } */
  </style>
</head>
<body>
  <header>
    <!-- *** CHANGED: Updated heading *** -->
    <h1 id="page-title">My Favorites</h1>
    <!-- *** CHANGED: Updated search placeholder *** -->
    <input type="text" id="search-bar" placeholder="Search Favorites..." style="width: 100%; padding: 10px; margin-bottom: 20px;">
  </header>
  <main>
    <section id="index-container">
      <div id="search-results" style="margin-top: 10px;"></div>
      <!-- *** Renamed logically to item-list *** -->
      <div id="vn-list"></div>
      <div id="pagination" class="pagination"></div>
    </section>
    <section id="details-container" class="vn-container">
      <!-- *** Renamed logically to item-details *** -->
      <article id="vn-details"></article>
      <a href="#" id="back-to-index">Back to List</a>
    </section>
  </main>
  <footer>
    2025
  </footer>
  <script>
    const baseUrl = 'https://yuushaexa.github.io/headless/';
    // *** CHANGED: Updated hobby identifier ***
    const hobby = 'favs';

    // Function to parse URL parameters (no change needed)
    function getUrlParameter(name) {
      name = name.replace(/[\[\]]/g, '\\$&');
      const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
      const results = regex.exec(window.location.href);
      if (!results) return null;
      if (!results[2]) return '';
      return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }

    // Function to update URL without reloading (no change needed)
    function updateUrl(path) {
      if (!path) {
          console.warn("Attempted to update URL with invalid path:", path);
          return;
      }
      const newUrl = window.location.pathname + '?json=' + encodeURIComponent(path);
      // Use replaceState for the very first load to avoid polluting history
      const firstLoadPath = `${hobby}/posts/index.json`;
      if (!history.state && path === firstLoadPath) {
         window.history.replaceState({ path: path }, '', newUrl);
      } else {
         window.history.pushState({ path: path }, '', newUrl);
      }
    }

    // *** CHANGED: Renamed function, updated fetch URL logic slightly for clarity ***
    // Fetch and display items (List View)
    async function fetchItems(listUrl) {
      console.log("Fetching Item List:", listUrl); // Debug log
      try {
        const response = await fetch(listUrl);
        if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
        const data = await response.json();
        renderItems(data.posts); // *** CHANGED: Call renamed function
        renderPagination(data.pagination);
        showIndexPage(); // Ensure the correct view is shown
      } catch (error) {
        console.error('Error fetching items:', error);
        document.getElementById('vn-list').innerHTML = '<p>Error loading items.</p>';
        document.getElementById('pagination').innerHTML = '';
        showIndexPage();
      }
    }

    // *** CHANGED: Renamed function, adapted template for 'favs' structure ***
    // Render items into the template
    function renderItems(posts) {
      const itemList = document.getElementById('vn-list'); // Still using 'vn-list' ID
      if (!posts || posts.length === 0) {
          itemList.innerHTML = '<p>No items found.</p>';
          return;
      }
      itemList.innerHTML = posts.map(post => `
        <div class="vn-container">
          <div class="vn-title">
            <a href="#" data-item-link="${post.link}">${post.title}</a>
          </div>
          <!-- Description removed as it's not in the list data -->
          <!-- Image handling updated: check if post.image is a truthy string -->
          ${post.image ? `<img class="vn-image" src="${post.image}" alt="${post.title}">` : ''}
        </div>
      `).join('');

      // Add event listeners to item links
      // *** CHANGED: Use data-item-link attribute ***
      document.querySelectorAll('.vn-title a[data-item-link]').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const itemLink = e.target.getAttribute('data-item-link');
          if (itemLink) {
            updateUrl(itemLink);
            fetchAndRenderDetails(itemLink); // Call detail fetcher
          }
        });
      });
    }

    // Render pagination (no change needed in logic, uses pagination object directly)
    function renderPagination(pagination) {
        const paginationContainer = document.getElementById('pagination');
        if (!pagination || typeof pagination.currentPage === 'undefined' || typeof pagination.totalPages === 'undefined') {
            paginationContainer.innerHTML = ''; // Clear pagination if data is invalid/missing
            return;
        }

        let paginationHTML = '';
        // Add Previous link if applicable
        if (pagination.previousPage) {
            paginationHTML += `<a href="#" data-page="${pagination.previousPage}">Previous</a>`;
        } else {
            paginationHTML += `<span style="color: #ccc;">Previous</span>`; // Disabled look
        }

        // Display current page info (only if totalPages > 0)
        if (pagination.totalPages > 0) {
           paginationHTML += ` <span>Page ${pagination.currentPage} of ${pagination.totalPages}</span> `;
        } else {
            paginationHTML += ` <span>Page 1 of 1</span> `; // Handle case of 0 total pages (e.g., single page result)
        }


        // Add Next link if applicable
        if (pagination.nextPage) {
            paginationHTML += `<a href="#" data-page="${pagination.nextPage}">Next</a>`;
        } else {
             paginationHTML += `<span style="color: #ccc;">Next</span>`; // Disabled look
        }

        paginationContainer.innerHTML = paginationHTML;

        // Add event listeners to pagination links
        paginationContainer.querySelectorAll('a[data-page]').forEach(link => {
            link.addEventListener('click', (e) => {
            e.preventDefault();
            const pagePath = e.target.getAttribute('data-page');
            if (pagePath) {
                updateUrl(pagePath);
                // *** CHANGED: Call fetchItems ***
                fetchItems(`${baseUrl}${pagePath}`);
            }
            });
        });
    }


    // *** CHANGED: Renamed function ***
    // Fetch and render details for a specific item (Detail View)
    async function fetchAndRenderDetails(itemLink) {
      console.log("Fetching Item Details:", `${baseUrl}${itemLink}`); // Debug log
      try {
        const response = await fetch(`${baseUrl}${itemLink}`);
        if (!response.ok) {
            // Handle potential 404 or other errors for detail files that might not exist
            if (response.status === 404) {
                 console.warn(`Detail file not found: ${itemLink}`);
                 // Optionally show a specific message or default content
                 renderDetails(null); // Pass null to indicate not found
            } else {
                throw new Error(`Network response was not ok: ${response.statusText}`);
            }
        } else {
            const itemDetails = await response.json();
            renderDetails(itemDetails);
        }
        showDetailsPage(); // Ensure the correct view is shown
        // Update page title AFTER fetching, handle null case
        document.getElementById('page-title').textContent = itemDetails?.title || 'Details Not Found';
      } catch (error) {
        console.error('Error fetching item details:', error);
         document.getElementById('vn-details').innerHTML = '<p>Error loading details.</p>';
         showDetailsPage();
         document.getElementById('page-title').textContent = 'Error'; // Update title on error
      }
    }

    // *** CHANGED: Renamed function, simplified template for 'favs' detail structure ***
    // Render Item details into the template
    function renderDetails(post) {
      const detailsContainer = document.getElementById('vn-details'); // Still using 'vn-details' ID

      // Handle case where detail file wasn't found or post is invalid
      if (!post || !post.title) {
          detailsContainer.innerHTML = `
             <div class="vn-title">Item Details Not Found</div>
             <div class="vn-description">The specific details for this item could not be loaded. It might be missing or there was an error.</div>
             <p><a href="${baseUrl}${getUrlParameter('json')}" target="_blank" rel="noopener noreferrer">View Raw JSON</a> (if available)</p>
          `;
           // Update title just in case it wasn't set correctly in the catch block
          document.getElementById('page-title').textContent = 'Details Not Found';
          return;
      }

      // Render the basic details available
      detailsContainer.innerHTML = `
        <div class="vn-title">${post.title}</div>
        <!-- Assuming no description in detail JSON based on example, add if available -->
        <!-- <div class="vn-description">${post.description || 'No description available.'}</div> -->
        ${post.image ? `<img class="vn-image" src="${post.image}" alt="${post.title}">` : '<p>No image available.</p>'}
        <!-- Removed developers, tags, screenshots sections -->
        <p>Link: <a href="${baseUrl}${post.link}" target="_blank" rel="noopener noreferrer">${post.link}</a></p>
        <!-- You could add a link to the original source if the 'image' field is used for that -->
        ${post.image && post.image.startsWith('http') ? `<p>Source Link: <a href="${post.image}" target="_blank" rel="noopener noreferrer">${post.image}</a></p>` : ''}

      `;
      // No developer links or other complex elements to attach listeners to in this simplified view.
    }

    // --- REMOVED Developer specific functions ---
    // async function fetchAndRenderDeveloperDetails(developerLink) { ... }
    // function renderDeveloperDetails(developer) { ... }

    // Show the index page (list view) (no change needed)
    function showIndexPage() {
      document.getElementById('index-container').style.display = 'block';
      document.getElementById('details-container').style.display = 'none';
      // *** CHANGED: Consistent title setting ***
      document.getElementById('page-title').textContent = 'My Favorites';
      document.getElementById('search-bar').style.display = 'block';
    }

    // Show the details page (Item Detail) (no change needed)
    function showDetailsPage() {
      document.getElementById('index-container').style.display = 'none';
      document.getElementById('details-container').style.display = 'block';
      // Title is set within the fetchAndRenderDetails function
      document.getElementById('search-bar').style.display = 'none';
    }

    // Back to index page click handler (no change needed)
    document.getElementById('back-to-index').addEventListener('click', (e) => {
      e.preventDefault();
      const defaultIndexPath = `${hobby}/posts/index.json`;
      // Check history state - if previous state exists and was a list page, go back
      if (history.state && history.state.path && (history.state.path === defaultIndexPath || history.state.path.startsWith(`${hobby}/posts/page/`))) {
         history.back(); // Use browser back to return to the previous list state
      } else {
         // Otherwise, navigate explicitly to the first page
         updateUrl(defaultIndexPath);
         fetchItems(`${baseUrl}${defaultIndexPath}`); // *** CHANGED: Call fetchItems ***
      }
    });

    // --- UPDATED Popstate Handler (Removed developer logic) ---
    window.addEventListener('popstate', (event) => {
      const jsonParam = getUrlParameter('json');
      console.log("Popstate triggered. Path from state:", event.state?.path, "URL jsonParam:", jsonParam); // Debugging

      const targetPath = event.state?.path || jsonParam;
      const defaultIndexPath = `${hobby}/posts/index.json`;

      if (targetPath) {
        const fullUrl = `${baseUrl}${targetPath}`;

        // Check for list pages (index or page/N)
        if (targetPath === defaultIndexPath || targetPath.startsWith(`${hobby}/posts/page/`)) {
          console.log("Popstate: Loading list page:", targetPath);
          fetchItems(fullUrl); // *** CHANGED: Call fetchItems ***
        }
        // Check for Item detail pages (ensure it's not a list page)
        else if (targetPath.startsWith(`${hobby}/posts/`) && !targetPath.includes('/page/')) {
           console.log("Popstate: Loading item details:", targetPath);
           fetchAndRenderDetails(targetPath); // *** CHANGED: Call fetchAndRenderDetails ***
        }
        // Handle unknown patterns - default to index
        else {
          console.warn("Popstate: Unhandled path:", targetPath, "Defaulting to index.");
          fetchItems(`${baseUrl}${defaultIndexPath}`); // *** CHANGED: Call fetchItems ***
          // Update URL to reflect the default state we loaded
          updateUrl(defaultIndexPath);
        }
      } else {
        // No path found in state or URL param - load the default index page
        console.log("Popstate: No path found, loading default index.");
        fetchItems(`${baseUrl}${defaultIndexPath}`); // *** CHANGED: Call fetchItems ***
        // Update URL to reflect the default state we loaded (use replaceState)
        const newUrl = window.location.pathname + '?json=' + encodeURIComponent(defaultIndexPath);
        window.history.replaceState({ path: defaultIndexPath }, '', newUrl);
      }
    });
    // --- End of UPDATED Popstate Handler ---


    // Fetch initial data on page load (Removed developer logic)
    document.addEventListener('DOMContentLoaded', () => {
      const jsonParam = getUrlParameter('json');
      const defaultIndexPath = `${hobby}/posts/index.json`;
      const initialPath = jsonParam || defaultIndexPath; // Default to index if no param

      console.log("DOMContentLoaded: Initial path determined as:", initialPath);

      // Determine what content to load based on the initial path
      if (initialPath === defaultIndexPath || initialPath.startsWith(`${hobby}/posts/page/`)) {
          fetchItems(`${baseUrl}${initialPath}`); // *** CHANGED: Call fetchItems ***
          // Update URL only if jsonParam was null initially (to add the default)
          if (!jsonParam) {
              updateUrl(initialPath);
          }
      } else if (initialPath.startsWith(`${hobby}/posts/`) && !initialPath.includes('/page/')) {
          fetchAndRenderDetails(initialPath); // *** CHANGED: Call fetchAndRenderDetails ***
      } else {
          // Fallback for unknown initial path - load index
          console.warn("DOMContentLoaded: Unhandled initial path:", initialPath, "Loading default index.");
          fetchItems(`${baseUrl}${defaultIndexPath}`); // *** CHANGED: Call fetchItems ***
          updateUrl(defaultIndexPath); // Ensure URL reflects the loaded state
      }

       // Initialize search
       if (typeof initializeSearch === 'function') {
            initializeSearch(baseUrl, hobby, renderSearchResults, clearSearchResults);
       } else {
            console.warn("Search initialization function not found.");
       }
    });

    // --- Search related functions (Updated template) ---
    function renderSearchResults(results) {
        const resultsContainer = document.getElementById('search-results');
        const itemListContainer = document.getElementById('vn-list'); // Still 'vn-list' ID
        const paginationContainer = document.getElementById('pagination');

        if (results && results.length > 0) {
            itemListContainer.style.display = 'none'; // Hide regular list
            paginationContainer.style.display = 'none'; // Hide pagination
            resultsContainer.style.display = 'block'; // Show results container
            // *** CHANGED: Adapted template for 'favs' search results ***
            resultsContainer.innerHTML = results.map(post => `
                <div class="vn-container">
                  <div class="vn-title">
                    <!-- *** CHANGED: Use data-item-link *** -->
                    <a href="#" data-item-link="${post.link}">${post.title}</a>
                  </div>
                  <!-- Description removed -->
                  <!-- Image handling updated -->
                  ${post.image ? `<img class="vn-image" src="${post.image}" alt="${post.title}">` : ''}
                </div>
            `).join('');

            // Add event listeners for search result links
            // *** CHANGED: Use data-item-link ***
             resultsContainer.querySelectorAll('a[data-item-link]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const itemLink = e.target.closest('a').getAttribute('data-item-link');
                     if (itemLink) {
                        updateUrl(itemLink);
                        fetchAndRenderDetails(itemLink); // *** CHANGED: Call fetchAndRenderDetails ***
                        clearSearchResults(); // Clear search results when navigating away
                        document.getElementById('search-bar').value = ''; // Clear search bar text
                     }
                });
             });

        } else {
            resultsContainer.innerHTML = '<p>No results found.</p>';
            resultsContainer.style.display = 'block';
             itemListContainer.style.display = 'none'; // Keep regular list hidden
             paginationContainer.style.display = 'none'; // Keep pagination hidden
        }
    }

    // Function to clear search results (no change needed)
    function clearSearchResults() {
        const resultsContainer = document.getElementById('search-results');
        const itemListContainer = document.getElementById('vn-list');
        const paginationContainer = document.getElementById('pagination');

        resultsContainer.innerHTML = '';
        resultsContainer.style.display = 'none';
        itemListContainer.style.display = 'block'; // Show regular list again
        paginationContainer.style.display = 'block'; // Show pagination again
    }
    // --- End of Search related functions ---

  </script>
  <!-- Ensure search.js is loaded *after* the main script block -->
  <script src="/page/src/search.js"></script>
</body>
</html>
