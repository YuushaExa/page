<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visual Novels</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      line-height: 1.6; /* Improved readability */
    }
    header, main, footer {
      max-width: 900px; /* Limit width for better readability on large screens */
      margin-left: auto;
      margin-right: auto;
    }
    .vn-container {
      border: 1px solid #ddd;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 5px;
      background-color: #fff; /* Add background for contrast */
    }
    .vn-title {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .vn-title a {
      text-decoration: none;
      color: #007bff;
    }
    .vn-title a:hover {
      text-decoration: underline;
    }
    .vn-description {
      font-size: 16px;
      color: #555;
      margin-bottom: 10px;
    }
    .vn-image {
      max-width: 100%;
      height: auto;
      margin-bottom: 10px;
      border-radius: 3px; /* Slightly rounded images */
    }
    .pagination {
      margin-top: 20px;
      text-align: center;
    }
    .pagination a, .pagination span { /* Style span too */
      margin: 0 5px;
      text-decoration: none;
      color: #007bff;
      padding: 5px 10px; /* Add padding */
      border: 1px solid transparent; /* Layout consistency */
      border-radius: 3px;
    }
    .pagination span {
      color: #555; /* De-emphasize non-link text */
    }
    .pagination a:hover {
        background-color: #f0f0f0;
        border-color: #ddd;
    }
    .pagination a.active { /* Keep active style if needed later */
      font-weight: bold;
      color: #000;
    }
    .vn-details-section { /* Class for detail sections */
      margin-bottom: 15px;
      padding-left: 5px; /* Indent slightly */
      border-left: 3px solid #eee; /* Visual separation */
    }
    .vn-details-section strong {
        display: block;
        margin-bottom: 5px;
    }
    .vn-details-section ul {
      list-style-type: none;
      padding: 0;
      margin: 0; /* Remove default margin */
    }
    .vn-details-section li {
      display: inline-block;
      margin-right: 8px;
      margin-bottom: 5px; /* Spacing for wrapping items */
    }
    .tag-item { /* Specific style for tags */
        background-color: #e9ecef;
        padding: 3px 8px;
        border-radius: 10px; /* Pill shape */
        font-size: 0.9em;
        color: #495057;
    }
    .vn-screenshots img {
      max-width: 120px; /* Slightly larger */
      height: auto; /* Maintain aspect ratio */
      margin-right: 10px;
      border: 1px solid #ddd;
      border-radius: 3px;
      vertical-align: middle; /* Align images nicely */
    }
    #details-container {
      display: none; /* Hide details by default */
    }
    #back-to-index {
      display: inline-block; /* Treat like a button */
      margin-top: 20px;
      padding: 8px 15px;
      text-decoration: none;
      color: #007bff;
      border: 1px solid #007bff;
      border-radius: 3px;
    }
    #back-to-index:hover {
        background-color: #007bff;
        color: white;
    }
    .vn-post-image { /* Kept from original, ensure usage */
      max-width: 50px;
      height: auto;
      margin-left: 10px;
    }
    #search-bar { /* Moved from inline */
      width: 100%;
      padding: 10px;
      margin-bottom: 20px;
      box-sizing: border-box; /* Include padding in width */
      border: 1px solid #ccc;
      border-radius: 3px;
    }
    .loading-indicator, .error-message {
        text-align: center;
        padding: 20px;
        font-size: 1.1em;
        display: none; /* Hidden by default */
    }
    .error-message {
        color: #dc3545;
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 5px;
    }
  </style>
</head>
<body>
  <header>
    <h1 id="page-title">Visual Novels</h1>
    <input type="text" id="search-bar" placeholder="Search Visual Novels..." >
  </header>
  <main>
    <div id="loading-indicator" class="loading-indicator">Loading...</div>
    <div id="error-message" class="error-message"></div>

    <section id="index-container">
      <div id="search-results" style="margin-top: 10px;"></div>
      <div id="vn-list"></div>
      <div id="pagination" class="pagination"></div>
    </section>

    <section id="details-container"> <!-- Removed vn-container class here -->
      <article id="vn-details" class="vn-container"></article> <!-- Added vn-container class here -->
      <a href="#" id="back-to-index">Back to List</a>
    </section>
  </main>
  <footer>
    <p style="text-align: center; color: #777; font-size: 0.9em;">Â© 2025</p> <!-- Added P tag and copyright symbol -->
  </footer>

  <script>
    // Configuration
    const baseUrl = 'https://yuushaexa.github.io/headless/';
    const hobby = 'vn'; // Assuming this might change, keep it configurable

    // DOM Element Cache
    const elements = {
        pageTitle: document.getElementById('page-title'),
        searchBar: document.getElementById('search-bar'),
        loadingIndicator: document.getElementById('loading-indicator'),
        errorMessage: document.getElementById('error-message'),
        indexContainer: document.getElementById('index-container'),
        searchResults: document.getElementById('search-results'),
        vnList: document.getElementById('vn-list'),
        pagination: document.getElementById('pagination'),
        detailsContainer: document.getElementById('details-container'),
        vnDetails: document.getElementById('vn-details'),
        backToIndex: document.getElementById('back-to-index'),
    };

    // --- Utility Functions ---

    function getUrlParameter(name) {
      name = name.replace(/[\[\]]/g, '\\$&');
      const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
      const results = regex.exec(window.location.href);
      if (!results) return null;
      if (!results[2]) return '';
      return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }

    function updateUrl(path) {
      // Only push state if the path is different from the current one represented in the URL
      const currentJsonParam = getUrlParameter('json');
      if (path !== currentJsonParam) {
          const newUrl = `${window.location.pathname}?json=${encodeURIComponent(path)}`;
          // console.log("Pushing state:", path); // Debug log
          window.history.pushState({ path: path }, '', newUrl);
      }
    }

    // --- UI State Management ---

    function showLoading() {
        elements.loadingIndicator.style.display = 'block';
        elements.errorMessage.style.display = 'none'; // Hide previous errors
        elements.vnList.style.display = 'none'; // Hide content while loading
        elements.pagination.style.display = 'none';
        elements.vnDetails.style.display = 'none'; // Hide details content
    }

    function hideLoading() {
        elements.loadingIndicator.style.display = 'none';
    }

    function showError(message) {
        elements.errorMessage.textContent = `Error: ${message}`;
        elements.errorMessage.style.display = 'block';
        hideLoading(); // Hide loading indicator if error occurs
        // Decide what content should be visible on error
        elements.vnList.style.display = 'none';
        elements.pagination.style.display = 'none';
        elements.vnDetails.style.display = 'none';
    }

    function showIndexPage() {
        elements.indexContainer.style.display = 'block';
        elements.detailsContainer.style.display = 'none';
        elements.pageTitle.textContent = 'Visual Novels';
        // Ensure list and pagination are potentially visible (if not loading/error)
        elements.vnList.style.display = 'block';
        elements.pagination.style.display = 'block';
        elements.vnDetails.style.display = 'none'; // Explicitly hide details content
        elements.errorMessage.style.display = 'none'; // Hide errors when navigating back
    }

    function showDetailsPage(title = 'Details') {
        elements.indexContainer.style.display = 'none';
        elements.detailsContainer.style.display = 'block';
        elements.pageTitle.textContent = title; // Use specific title
        // Ensure details content is potentially visible (if not loading/error)
        elements.vnDetails.style.display = 'block';
        elements.errorMessage.style.display = 'none'; // Hide errors when navigating
    }

    // --- Data Fetching ---

    async function fetchData(url) {
        showLoading();
        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`Network response was not ok (${response.status} ${response.statusText})`);
            }
            const data = await response.json();
            hideLoading();
            return data;
        } catch (error) {
            console.error('Fetch error:', error);
            showError(error.message || 'Failed to fetch data.');
            throw error; // Re-throw to allow calling function to know about the error
        }
    }

    // --- Rendering Functions ---

    function renderVisualNovelListItem(post) {
        return `
            <div class="vn-container">
                <div class="vn-title">
                    <a href="#" data-link="${post.link}">${post.title}</a>
                </div>
                <div class="vn-description">${post.description || 'No description available.'}</div>
                ${post.image?.url ? `<img class="vn-image" src="${post.image.url}" alt="${post.title}">` : ''}
            </div>
        `;
    }

    function renderVisualNovels(posts) {
        if (!posts || posts.length === 0) {
            elements.vnList.innerHTML = '<p>No visual novels found.</p>';
            return;
        }
        elements.vnList.innerHTML = posts.map(renderVisualNovelListItem).join('');
        // Add event listeners AFTER rendering
        elements.vnList.querySelectorAll('.vn-title a').forEach(link => {
            link.addEventListener('click', handleLinkClick);
        });
    }

    function renderPagination(pagination) {
        if (!pagination || pagination.totalPages <= 1) {
            elements.pagination.innerHTML = ''; // No pagination needed for 0 or 1 pages
            return;
        }
        elements.pagination.innerHTML = `
            ${pagination.previousPage ? `<a href="#" data-link="${hobby}/posts/${pagination.previousPage}">Previous</a>` : '<span>Previous</span>'}
            <span>Page ${pagination.currentPage} of ${pagination.totalPages}</span>
            ${pagination.nextPage ? `<a href="#" data-link="${hobby}/posts/${pagination.nextPage}">Next</a>` : '<span>Next</span>'}
        `;
        // Add event listeners AFTER rendering
        elements.pagination.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', handleLinkClick);
        });
    }

    function renderDetailsPage(post, type = 'vn') { // type can be 'vn' or 'developer'
        const title = post.title || 'Details'; // Fallback title
        elements.vnDetails.innerHTML = `
            <div class="vn-title">${title}</div>
            <div class="vn-description">${post.description || 'No description available.'}</div>
            ${post.image?.url ? `<img class="vn-image" src="${post.image.url}" alt="${title}">` : ''}

            ${type === 'vn' && post.developers?.length ? `
                <div class="vn-details-section vn-developers">
                    <strong>Developers:</strong>
                    <ul>${post.developers.map(dev => `
                        <li><a href="#" data-link="${dev.link}">${dev.title}</a></li>
                    `).join('')}</ul>
                </div>
            ` : ''}

            ${type === 'vn' && post.tags?.length ? `
                <div class="vn-details-section vn-tags">
                    <strong>Tags:</strong>
                    <ul>${post.tags.map(tag => `<li class="tag-item">${tag}</li>`).join('')}</ul>
                </div>
            ` : ''}

            ${type === 'vn' && post.screenshots?.length ? `
                <div class="vn-details-section vn-screenshots">
                    <strong>Screenshots:</strong>
                    <ul>${post.screenshots.map(ss => `<li><img src="${ss.url}" alt="Screenshot"></li>`).join('')}</ul>
                </div>
            ` : ''}

            ${type === 'developer' && post.posts?.length ? `
                <div class="vn-details-section vn-posts">
                    <strong>Visual Novels by ${title}:</strong>
                    ${post.posts.map(renderVisualNovelListItem).join('')}
                </div>
            ` : ''}
        `;
        showDetailsPage(title); // Update page title and visibility

        // Add event listeners AFTER rendering for any links within the details
        elements.vnDetails.querySelectorAll('a[data-link]').forEach(link => {
            link.addEventListener('click', handleLinkClick);
        });
    }

    // --- Event Handlers & Navigation Logic ---

    function handleLinkClick(event) {
        event.preventDefault();
        const link = event.currentTarget.getAttribute('data-link');
        if (link) {
            // console.log("Link clicked, navigating to:", link); // Debug log
            updateUrl(link);
            navigateTo(link);
        }
    }

    async function navigateTo(path) {
        try {
            const fullUrl = `${baseUrl}${path}`;
            const data = await fetchData(fullUrl);

            // Determine content type based on path structure (adjust regex if paths change)
            if (path.includes('/posts/index') || path.includes('/posts/page')) {
                // Index or Paginated List
                renderVisualNovels(data.posts);
                renderPagination(data.pagination);
                showIndexPage();
            } else if (path.startsWith(`${hobby}/developers/`)) {
                // Developer Detail Page
                renderDetailsPage(data, 'developer');
            } else if (path.startsWith(`${hobby}/posts/`)) {
                // Specific VN Detail Page (assuming structure)
                renderDetailsPage(data, 'vn');
            } else {
                // Fallback or unknown path type - default to index?
                console.warn("Unknown path structure:", path);
                showError("Could not determine content type for this link.");
                // Optionally, navigate to a known good state:
                // updateUrl(`${hobby}/posts/index.json`);
                // navigateTo(`${hobby}/posts/index.json`);
            }
             // Clear search results when navigating via links
            elements.searchResults.innerHTML = '';
            elements.searchBar.value = ''; // Clear search bar text

        } catch (error) {
            // Error already handled by showError in fetchData
            console.error("Navigation failed for path:", path, error);
        }
    }

    function handlePopState(event) {
      const path = event.state?.path || getUrlParameter('json'); // Use state first, fallback to URL param
      // console.log("Popstate event, path:", path); // Debug log
      if (path) {
          navigateTo(path);
      } else {
          // If no path in state or URL, default to index
          const defaultPath = `${hobby}/posts/index.json`;
          // console.log("Popstate: No path found, navigating to default:", defaultPath); // Debug log
          // Update URL silently to reflect the default state if needed, then navigate
          const currentUrl = `${window.location.pathname}?json=${encodeURIComponent(defaultPath)}`;
          window.history.replaceState({ path: defaultPath }, '', currentUrl); // Use replaceState to not create extra history entry
          navigateTo(defaultPath);
      }
    }

    // --- Initialization ---

    function initialize() {
        // Attach static event listeners
        elements.backToIndex.addEventListener('click', (e) => {
            e.preventDefault();
            const indexPath = `${hobby}/posts/index.json`;
            updateUrl(indexPath);
            navigateTo(indexPath);
        });

        window.addEventListener('popstate', handlePopState);

        // Initial load logic
        const initialPath = getUrlParameter('json');
        if (initialPath) {
            // console.log("Initial load with path:", initialPath); // Debug log
            navigateTo(initialPath);
        } else {
            const defaultPath = `${hobby}/posts/index.json`;
            // console.log("Initial load: No path, navigating to default:", defaultPath); // Debug log
            updateUrl(defaultPath); // Set the initial URL correctly
            navigateTo(defaultPath);
        }

        // Load and initialize search functionality (if search.js exists and is needed)
        if (typeof initializeSearch === 'function') {
             // Pass necessary elements/config if search.js needs them
            initializeSearch({
                searchBar: elements.searchBar,
                resultsContainer: elements.searchResults,
                baseUrl: baseUrl,
                hobby: hobby,
                handleLinkClick: handleLinkClick // Allow search results to use same navigation
            });
        } else {
            console.warn("Search script ('/page/src/search.js') or initializeSearch function not found.");
        }
    }

    // Start the application
    document.addEventListener('DOMContentLoaded', initialize);

  </script>
  <!-- Ensure the search script is loaded AFTER the main script or wrapped in its own DOMContentLoaded -->
  <!-- It should define an `initializeSearch` function if it follows the pattern above -->
  <script src="/page/src/search.js"></script>
</body>
</html>
