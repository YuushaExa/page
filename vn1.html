<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visual Novels</title>
  <!-- Removed OG Meta Tags -->
  <style>
  body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .vn-container {
      border: 1px solid #ddd;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 5px;
    }
    .vn-title {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .vn-title a {
      text-decoration: none;
      color: #007bff;
    }
    .vn-title a:hover {
      text-decoration: underline;
    }
    .vn-description {
      font-size: 16px;
      color: #555;
      margin-bottom: 10px;
    }
    .vn-image {
      max-width: 100%;
      height: auto;
      margin-bottom: 10px;
    }
    .pagination {
      margin-top: 20px;
      text-align: center;
    }
    .pagination a {
      margin: 0 5px;
      text-decoration: none;
      color: #007bff;
    }
    .pagination a.active {
      font-weight: bold;
      color: #000;
    }
    .vn-developers, .vn-tags, .vn-screenshots {
      margin-bottom: 10px;
    }
    .vn-developers ul, .vn-tags ul, .vn-screenshots ul {
      list-style-type: none;
      padding: 0;
    }
    .vn-developers li, .vn-tags li {
      display: inline-block;
      margin-right: 10px;
      background-color: #f0f0f0;
      padding: 5px 10px;
      border-radius: 3px;
    }
    .vn-screenshots img {
      max-width: 100px;
      margin-right: 10px;
    }
    #details-container {
      display: none; /* Hide details by default */
    }
    #back-to-index {
      display: block;
      margin-top: 20px;
      text-decoration: none;
      color: #007bff;
    }
    .vn-post-image {
      max-width: 50px;
      height: auto;
      margin-left: 10px;
    }
    #details-container {
      /* Keep details hidden initially */
       display: none;
    }
  </style>
</head>
<header>
  <h1 id="page-title">Visual Novels</h1>
  <input type="text" id="search-bar" placeholder="Search Visual Novels..." style="width: 100%; padding: 10px; margin-bottom: 20px;">
</header>
<body>
<main>
  <section id="index-container">
    <div id="search-results" style="margin-top: 10px;"></div>
    <div id="vn-list"></div>
    <div id="pagination" class="pagination"></div>
  </section>
  <section id="details-container" class="vn-container">
    <article id="vn-details"></article>
    <!-- Make this a link to the root route -->
    <a href="/" id="back-to-index">Back to List</a>
  </section>
</main>
<footer>
  2025
</footer>

<!-- Add Page.js library -->
 <script src="/page/src/mini-router.js"></script>
  <script>
    const baseUrl = 'https://yuushaexa.github.io/headless/';
    const hobby = 'vn'; // Assuming 'vn' is the base for VNs

    // --- Helper function to extract slug from API link ---
    function extractSlug(link) {
        // Assumes link format like "vn/some-slug.json" or "developer/dev-slug.json"
        const parts = link.split('/');
        if (parts.length > 1) {
            return parts[1].replace('.json', '');
        }
        return null; // Or handle error/default
    }

    // --- Fetch and display visual novels (for index/pagination) ---
    async function fetchVisualNovelsList(page = 1) {
      const pageFile = page <= 1 ? 'index.json' : `page-${page}.json`;
      const url = `${baseUrl}${hobby}/posts/${pageFile}`;
      console.log(`Fetching list: ${url}`);
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Network response was not ok for ${url}`);
        const data = await response.json();
        renderVisualNovels(data.posts);
        renderPagination(data.pagination);
        showIndexPage(); // Ensure index view is visible
      } catch (error) {
        console.error('Error fetching visual novels list:', error);
        document.getElementById('vn-list').innerHTML = '<p>Error loading visual novels.</p>';
        document.getElementById('pagination').innerHTML = '';
      }
    }

    // --- Render visual novels into the template ---
    function renderVisualNovels(posts) {
      const vnList = document.getElementById('vn-list');
      vnList.innerHTML = posts.map(post => {
        const slug = extractSlug(post.link); // Get slug for the URL
        return `
        <div class="vn-container">
          <div class="vn-title">
            <!-- Use real href for routing -->
            <a href="/vn/${slug}">${post.title}</a>
          </div>
          <div class="vn-description">${post.description}</div>
          ${post.image?.url ? `<img class="vn-image" src="${post.image.url}" alt="${post.title}">` : ''}
        </div>
      `}).join('');
      // NO event listeners here anymore - handled by router
    }

    // --- Render pagination ---
    function renderPagination(pagination) {
      const paginationContainer = document.getElementById('pagination');
      let html = '';
      if (pagination.previousPage) {
          // Link to the specific page number URL
          html += `<a href="/page/${pagination.previousPage}">Previous</a> `;
      }
      html += `<span>Page ${pagination.currentPage} of ${pagination.totalPages}</span>`;
      if (pagination.nextPage) {
          // Link to the specific page number URL
          html += ` <a href="/page/${pagination.nextPage}">Next</a>`;
      }
      paginationContainer.innerHTML = html;
      // NO event listeners here anymore - handled by router
    }

    // --- Fetch and render details for a specific visual novel ---
    async function fetchAndRenderVNDetails(slug) {
      const url = `${baseUrl}${hobby}/${slug}.json`;
      console.log(`Fetching VN details: ${url}`);
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Network response was not ok for ${url}`);
        const vnDetails = await response.json();
        renderDetails(vnDetails); // Render the details
        document.getElementById('page-title').textContent = vnDetails.title; // Update page title
        showDetailsPage(); // Show the details view
      } catch (error) {
        console.error(`Error fetching VN details for slug ${slug}:`, error);
        document.getElementById('vn-details').innerHTML = '<p>Error loading details.</p>';
        showDetailsPage(); // Still show details page, but with error
      }
    }

    // --- Render VN details into the template ---
    function renderDetails(post) {
      const detailsContainer = document.getElementById('vn-details');
      const vnSlug = extractSlug(post.link); // Get current VN slug if needed later

      detailsContainer.innerHTML = `
        <div class="vn-title">${post.title}</div>
        <div class="vn-description">${post.description}</div>
        ${post.image?.url ? `<img class="vn-image" src="${post.image.url}" alt="${post.title}">` : ''}
        ${post.developers?.length ? `
          <div class="vn-developers">
            <strong>Developers:</strong>
            <ul>${post.developers.map(dev => {
              const devSlug = extractSlug(dev.link); // Get dev slug for URL
              return `
              <li>
                <!-- Use real href for routing -->
                <a href="/developer/${devSlug}">${dev.title}</a>
              </li>
            `}).join('')}</ul>
          </div>
        ` : ''}
        ${post.tags?.length ? `
          <div class="vn-tags">
            <strong>Tags:</strong>
            <ul>${post.tags.map(tag => `<li>${tag}</li>`).join('')}</ul>
          </div>
        ` : ''}
        ${post.screenshots?.length ? `
          <div class="vn-screenshots">
            <strong>Screenshots:</strong>
            <ul>${post.screenshots.map(screenshot => `<li><img src="${screenshot.url}" alt="Screenshot"></li>`).join('')}</ul>
          </div>
        ` : ''}
      `;
      // NO event listeners here anymore - handled by router
    }

    // --- Fetch and render details for a specific developer ---
    async function fetchAndRenderDeveloperDetails(slug) {
        const url = `${baseUrl}developer/${slug}.json`; // Assuming developers are not under 'vn' path
        console.log(`Fetching developer details: ${url}`);
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Network response was not ok for ${url}`);
        const developerDetails = await response.json();
        renderDeveloperDetails(developerDetails); // Render details
        document.getElementById('page-title').textContent = developerDetails.title; // Update title
        showDetailsPage(); // Show the details view
      } catch (error) {
        console.error(`Error fetching developer details for slug ${slug}:`, error);
        document.getElementById('vn-details').innerHTML = '<p>Error loading developer details.</p>';
        showDetailsPage();
      }
    }

    // --- Render developer details into the template ---
    function renderDeveloperDetails(developer) {
      const detailsContainer = document.getElementById('vn-details');
      detailsContainer.innerHTML = `
        <div class="vn-title">${developer.title}</div>
        <div class="vn-description">${developer.description || 'No description available.'}</div>
        ${developer.image?.url ? `<img class="vn-image" src="${developer.image.url}" alt="${developer.title}">` : ''}
        ${developer.posts?.length ? `
          <div class="vn-posts">
            <strong>Visual Novels by ${developer.title}:</strong>
            ${developer.posts.map(post => {
              const postSlug = extractSlug(post.link); // Get post slug for URL
              return `
              <div class="vn-container">
                <div class="vn-title">
                  <!-- Use real href for routing -->
                  <a href="/vn/${postSlug}">${post.title}</a>
                </div>
                <div class="vn-description">${post.description}</div>
                ${post.image?.url ? `<img class="vn-post-image" src="${post.image.url}" alt="${post.title}">` : ''}
              </div>
            `}).join('')}
          </div>
        ` : ''}
      `;
      // NO event listeners here anymore - handled by router
    }

    // --- Show the index page ---
    function showIndexPage() {
      console.log("Showing Index Page");
      document.getElementById('index-container').style.display = 'block';
      document.getElementById('details-container').style.display = 'none';
      document.getElementById('page-title').textContent = 'Visual Novels';
       // Clear search results when going back to index maybe?
       document.getElementById('search-results').innerHTML = '';
       document.getElementById('search-bar').value = '';
    }

    // --- Show the details page ---
    function showDetailsPage() {
      console.log("Showing Details Page");
      document.getElementById('index-container').style.display = 'none';
      document.getElementById('details-container').style.display = 'block';
      // Title is set within the detail fetch functions
       document.getElementById('search-results').innerHTML = ''; // Clear search results
    }

    // --- Modify the Back to List link ---
    // Change the href directly in the HTML
    // <a href="/" id="back-to-index">Back to List</a>


    // --- Define Routes using miniRouter ---
    document.addEventListener('DOMContentLoaded', () => {
        // Route for the homepage (first page of VNs)
        miniRouter.route('/', () => {
            console.log('Routing to /');
            fetchVisualNovelsList(1); // Fetch page 1
        });

        // Route for paginated index pages
        miniRouter.route('/page/:num', (ctx) => {
            console.log(`Routing to /page/${ctx.params.num}`);
            const pageNum = parseInt(ctx.params.num, 10);
            if (!isNaN(pageNum) && pageNum > 0) {
                fetchVisualNovelsList(pageNum);
            } else {
                console.error(`Invalid page number: ${ctx.params.num}`);
                miniRouter.navigate('/'); // Redirect to home on invalid page
            }
        });

        // Route for VN details
        miniRouter.route('/vn/:slug', (ctx) => {
            console.log(`Routing to /vn/${ctx.params.slug}`);
            fetchAndRenderVNDetails(ctx.params.slug);
        });

        // Route for Developer details
        miniRouter.route('/developer/:slug', (ctx) => {
            console.log(`Routing to /developer/${ctx.params.slug}`);
            fetchAndRenderDeveloperDetails(ctx.params.slug);
        });

        // --- Initialize the router ---
        miniRouter.start();

        // --- Keep Search Functionality Separate (for now) ---
        // The search.js script can still work independently or be integrated later if needed
        // If search results link to details pages, ensure they use the correct href format (e.g., /vn/slug)
    });

  </script>
  <script src="/page/src/search.js"></script> <!-- Ensure this exists or remove if not needed -->

</body>
</html>
